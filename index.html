<!DOCTYPE html>
<html lang="si">
<head>
<meta charset="UTF-8" /> 
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂∏‡∑í‡∂≠‡∑î‡∂ª‡∑è</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--brand:#0077b6;--accent:#0096c7;--bg:#e0f7fa}
  body{font-family:'Noto Sans Sinhala',sans-serif;margin:0;background:var(--bg);color:#023e8a}
  header{background:var(--brand);color:#fff;padding:1rem;text-align:center;box-shadow:0 4px 6px rgba(0,0,0,.12)}
  nav{display:flex;justify-content:center;background:#023e8a;flex-wrap:wrap}
  nav a{color:#fff;padding:0.75rem 1rem;text-decoration:none}
  nav a:hover{background:var(--accent);transform:scale(1.03)}
  section{padding:2rem}
  h1,h2{color:#023e8a}
  .letters{display:grid;grid-template-columns:repeat(auto-fit,minmax(60px,1fr));gap:10px;margin-top:1rem}
  .letter{font-size:2rem;text-align:center;background:#fff;border:2px solid var(--accent);border-radius:10px;padding:10px;cursor:pointer;transition:transform .15s}
  .letter:hover{transform:scale(1.08);background:#caf0f8}
  .game-dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem}
  .game-card{background:linear-gradient(135deg,#f9f9f9,#e0f7fa);padding:1rem;border-radius:14px;box-shadow:0 6px 12px rgba(0,0,0,.08);min-height:280px}
  canvas{border:1px solid var(--accent);border-radius:8px;background:white;width:100%;max-width:400px}
  .trace-controls{display:flex;gap:.5rem;justify-content:center;margin-top:.5rem}
  button{background:var(--brand);color:#fff;border:none;padding:.6rem 1rem;border-radius:8px;cursor:pointer}
  button:hover{background:var(--accent)}
  .motivation{color:green;font-weight:700;margin-top:.5rem}
  .grid-mini{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  .tile{background:var(--accent);color:#fff;border-radius:8px;padding:10px;text-align:center;cursor:pointer}
  .tile.correct{background:#2a9d8f}
  .tile.wrong{background:#e76f51}
  .stats{margin-top:.5rem;font-weight:700}
  footer{background:#023e8a;color:#fff;text-align:center;padding:1rem;margin-top:2rem}
  /* memory styling */
  .memory-grid{display:grid;grid-template-columns:repeat(4,90px);gap:12px;justify-content:center}
  .memory-card{width:90px;height:100px;perspective:800px;cursor:pointer}
  .memory-card-inner{position:relative;width:100%;height:100%;transition:transform .6s;transform-style:preserve-3d}
  .memory-card.flipped .memory-card-inner{transform:rotateY(180deg)}
  .memory-card-front,.memory-card-back{position:absolute;inset:0;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;backface-visibility:hidden}
  .memory-card-front{background:var(--accent);color:#fff}
  .memory-card-back{background:#fff;border:2px solid var(--accent);transform:rotateY(180deg);color:#023e8a}
  /* hidden admin */
  #adminPanel{display:none}
  /* responsive */
  @media(max-width:760px){ .game-dashboard{grid-template-columns:1fr} .memory-grid{grid-template-columns:repeat(3,90px)} }
</style>
</head>
<body>

<audio id="successSound" src="sounds/success.mp3"></audio>

<header>
  <h1>‚úçÔ∏è ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂∏‡∑í‡∂≠‡∑î‡∂ª‡∑è</h1>
  <p>‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î, ‡∑Ä‡∂†‡∂± ‡∑É‡∑Ñ ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂©‡∑è</p>
</header>

<nav>
  <a href="#home">üè† ‡∂∏‡∑î‡∂Ω‡∑ä ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä</a>
  <a href="#activities">üî° ‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫‡∑è‡∂ö‡∑è‡∂ª‡∂ö‡∂∏‡∑ä</a>
  <a href="#games">üéÆ ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂©‡∑è</a>
  <a href="#howto">üìñ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è</a>
  <a href="#faq">‚ùì ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±</a>
  <a href="#feedback">üìù ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä</a>
  <a href="#contact">üìû ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞</a>
</nav>

<section id="home">
  <h2>‡∂∏‡∑î‡∂Ω‡∑ä ‡∂¥‡∑í‡∂ß‡∑î‡∑Ä</h2>
  <p><b>‡∂Ö‡∂ª‡∂∏‡∑î‡∂´:</b> "‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂∏‡∑í‡∂≠‡∑î‡∂ª‡∑è" ‡∂∫‡∂±‡∑î <b>‡∂©‡∑í‡∑É‡∑ä‡∂ú‡∑ä‚Äç‡∂ª‡∑è‡∑Ü‡∑í‡∂∫‡∑è</b> ‡∂á‡∂≠‡∑í ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä‡∂ß ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä‡∑ô‡∂±‡∑ä ‡∂Ω‡∑í‡∑Ä‡∑ì‡∂∏ ‡∑É‡∑Ñ ‡∂ö‡∑í‡∂∫‡∑Ä‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì ‡∂¥‡∑Ñ‡∑É‡∑î‡∑Ä ‡∑É‡∂¥‡∂∫‡∂± ‡∂Ö‡∂©‡∑Ä‡∑í‡∂∫‡∂ö‡∑í.</p>
</section>

<!-- ACTIVITIES -->
<section id="activities">
  <h2>üî° ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±</h2>
  <p>‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∑ñ ‡∂Ö‡∂ö‡∑î‡∂ª ‡∂¢‡∑è‡∂Ω‡∂ö‡∂∫ ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∑É‡∑ú‡∂∫‡∑è ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</p>
  <h3>‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±: <span id="targetLetter" style="font-size:2rem;color:#d62828"></span></h3>
  <div class="letters" id="lettersGrid"></div>
  <p id="activityMsg" class="motivation"></p>
  <p class="stats"><b>‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í:</b> <span id="findScore">0</span> / <span id="findTotal">0</span> | <b>‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∑É‡∑è‡∂∞‡∂±‡∂∫:</b> <span id="findAccuracy">0%</span></p>
  <button onclick="newTarget()">‡∂±‡∑Ä ‡∂Ö‡∂ö‡∑î‡∂ª‡∂ö‡∑ä</button>
</section>

<!-- GAMES -->
<section id="games">
  <h2>üéÆ ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂©‡∑è ‡∂¥‡∑î‡∑Ä‡∂ª‡∑î‡∑Ä</h2>
  <div class="game-dashboard">

    <!-- Tracing -->
    <div class="game-card">
      <h3>‚úçÔ∏è ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂Ö‡∂≥‡∑í‡∂± ‡∂Ö‡∂∑‡∑í‡∂∫‡∑ù‡∂ú‡∂∫</h3>
      <p>‡∂Ö‡∂ö‡∑î‡∂ª‡∑ö‡∂Ø‡∑ì ‡∂Ö‡∑Ö‡∑î ‡∂Ø‡∑Ö ‡∑É‡∂ß‡∑Ñ‡∂± ‡∂ë‡∂ö‡∂ß ‡∑É‡∂∏‡∑ì‡∂¥‡∑Ä ‡∂Ö‡∂≥‡∑í‡∂±‡∑ä‡∂± ‚Äî ‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂≠‡∑è‡∑Ä % ‡∂Ø‡∂ö‡∑ä‡∑Ä‡∂∫‡∑í.</p>
      <canvas id="traceCanvas" width="300" height="300"></canvas>
      <div class="trace-controls">
        <button id="traceStartBtn">‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑</button>
        <button id="traceClearBtn">‡∂∏‡∂ö‡∂±‡∑ä‡∂±</button>
        <button id="traceNextBtn">‡∂ä‡∑Ö‡∂ü</button>
      </div>
      <p class="stats">‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂≠‡∑è‡∑Ä: <span id="traceAccuracy">0</span>%</p>
      <p id="traceMotivation" class="motivation"></p>
    </div>

    <!-- Memory -->
    <div class="game-card">
      <h3>üß† ‡∂∏‡∂≠‡∂ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂©‡∑è‡∑Ä</h3>
      <p>‡∂Ø‡∑ô‡∂¥‡∑ê‡∂≠‡∑ä‡∂≠‡∑ö ‡∑É‡∑í‡∂ß‡∑í‡∂± ‡∂ö‡∑è‡∂©‡∑ä 2 ‡∂ö‡∑ä ‡∂Ö‡∂Ø‡∑è‡∂Ω ‡∂Ö‡∂ö‡∑î‡∂ª ‡∑É‡∂∏‡∂ü ‡∑É‡∂∏‡∑è‡∂± ‡∂±‡∂∏‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.</p>
      <div id="memoryGame" class="memory-grid"></div>
      <div style="text-align:center;margin: top 0.6rem">
        <button id="memoryStartBtn">‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
      </div>
      <p class="motivation" id="memoryMotivation"></p>
      <p class="stats">‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂Ö‡∂±‡∑î‡∂¥‡∑í‡∑Ö‡∑í‡∑Ä‡∑ô‡∂Ω: <span id="memoryAccuracy">0</span>%</p>
    </div>

    <!-- Vowel/Consonant -->
    <div class="game-card">
      <h3>üÖ∞Ô∏è ‡∑É‡∑ä‡∑Ä‡∂ª / ‡∑Ä‡∑ä‚Äç‡∂∫‡∂Ç‡∂¢‡∂± ‡∑Ä‡∂ª‡∑ä‡∂ú‡∑ì‡∂ö‡∂ª‡∂´‡∂∫</h3>
      <p>‡∑É‡∑ä‡∑Ä‡∂ª ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.</p>
      <div id="vcGrid" class="grid-mini" style="margin-top:10px"></div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:.6rem">
        <button id="vcNewBtn">‡∂±‡∑Ä ‡∑Ä‡∂ß‡∂∫</button>
        <button id="vcRevealBtn">‡∂¥‡∑í‡∑Ö‡∑í‡∂≠‡∑î‡∂ª‡∑î ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂±‡∑ä‡∂±</button>
      </div>
      <p class="stats">‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í: <span id="vcCorrect">0</span> / <span id="vcTotal">0</span> | ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∑É‡∑è‡∂∞‡∂±‡∂∫: <span id="vcAcc">0%</span></p>
      <p id="vcMsg" class="motivation"></p>
    </div>

    <!-- Voice Recorder + Transcript -->
    <div class="game-card">
      <h3>üé§ ‡∑Ñ‡∂¨ ‡∂¥‡∂ß‡∑í‡∂ú‡∂≠ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ + ‡∂¥‡∑í‡∂ß‡∂¥‡∂≠ </h3>
      <p>REC ‚Üí ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä ‡∂ö‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‚Üí ‡∂¥‡∑í‡∂ß‡∂¥‡∂≠ ‡∂Ω‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±.</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px">
        <button id="startRecBtn">‚ñ∂Ô∏è ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑</button>
        <button id="stopRecBtn" disabled>‚èπÔ∏è ‡∂±‡∑Ä‡∂≠‡∑ä‡∑Ä‡∂±‡∑ä‡∂±</button>
        <button id="playRecBtn" disabled>üîä Play</button>
        <button id="downloadRecBtn" disabled>‚¨áÔ∏è Download</button>
      </div>
      <h4>üìù Transcript:</h4>
      <textarea id="transcript" rows="6" style="width:100%;border:1px solid var(--accent);border-radius:6px;padding:8px"></textarea>
      <audio id="recordedAudio" controls style="width:100%;margin-top:8px"></audio>
      <p class="stats">‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑ì‡∂∏: <span id="voiceAcc">0%</span></p>
    </div>

    <!-- Speed Tap -->
    <div class="game-card">
      <h3>‚ö°‡∂ö‡∑ä‡∑Ç‡∂´‡∑í‡∂ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂©‡∑è‡∑Ä</h3>
      <p>‡∑Ä‡∑ô‡∂Ω‡∑è‡∑Ä‡∑ö‡∂Ø‡∑ì ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö ‡∂Ö‡∂ö‡∑î‡∂ª ‡∂ß‡∑ä‚Äç‡∂ª‡∂∫‡∑í ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.</p>
      <p>‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∫: <span id="tapTarget" style="font-size:1.6rem;color:#d62828"></span></p>
      <div id="tapGrid" class="grid-mini" style="margin-top:8px"></div>
      <div style="display:flex;gap:8px;align-items:center;justify-content:center;margin-top:.6rem">
        <button id="tapStartBtn">‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑</button>
        <div>‚è±Ô∏è <span id="tapTimer">20</span>s</div>
      </div>
      <p class="stats">‡∂Ω‡∂ö‡∑î‡∂´‡∑î: <span id="tapScore">0</span> | ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ: <span id="tapAttempts">0</span> | ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫ ‡∑É‡∑è‡∂∞‡∂±‡∂∫: <span id="tapAcc">0%</span></p>
      <p id="tapMsg" class="motivation"></p>
    </div>

    <!-- Summary + Data Export -->
    <div class="game-card">
      <h3>üìä ‡∑É‡∂∏‡∑É‡∑ä‡∂≠ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∑‡∑è‡∑Ä‡∂∫ & ‡∂Ø‡∂≠‡∑ä‡∂≠</h3>
      <p>‡∑É‡∂∏‡∑É‡∑ä‡∂≠ ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∑‡∑è‡∑Ä‡∂∫: <b><span id="overallAccuracy">0</span>%</b></p>
      <div style="display:flex;gap:8px;flex-direction:column;align-items:center;margin-top:10px">
        <button onclick="calculateOverall()">‡∂ú‡∂´‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        <button onclick="downloadData()">‚¨áÔ∏è ‡∂Ø‡∂≠‡∑ä‡∂≠ (CSV) ‡∂∂‡∑è‡∂ú‡∂≠ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</button>
        <small style="color:#023e8a;margin-top:8px">(data stored locally in browser)</small>
      </div>
    </div>

  </div>
</section>

<!-- how to -->
<section id="howto" class="howto">
  <h2>üìñ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂± ‡∂Ö‡∂∫‡∑î‡∂ª‡∑î</h2>
  <ol>
    <li>üî° <b>‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±</b> ‚Üí ‡∂¥‡∑ô‡∂±‡∑ä‡∑Ä‡∂± ‡∂Ö‡∂ö‡∑î‡∂ª ‡∂¢‡∑è‡∂Ω‡∂ö‡∂∫ ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∑É‡∑ú‡∂∫‡∑è ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±. ‡∂Ω‡∂ö‡∑î‡∂´‡∑î ‡∑É‡∑Ñ % ‡∂Ø‡∂ª‡∑ä‡∑Å‡∂±‡∂∫ ‡∑Ä‡∑ö.</li>
    <li>‚úçÔ∏è <b>‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂Ö‡∂≥‡∑í‡∂± ‡∂Ö‡∂∑‡∑í‡∂∫‡∑ù‡∂ú‡∂∫</b> ‚Üí ‡∂≠‡∑í‡∂ª‡∂∫‡∑ö ‡∂Ö‡∑Ö‡∑î ‡∂Ø‡∑Ö ‡∑É‡∂ß‡∑Ñ‡∂± ‡∂∏‡∂≠ ‡∂Ö‡∂≥‡∑í‡∂± ‡∑Ä‡∑í‡∂ß ‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´‡∂≠‡∑è‡∑Ä % ‡∑Ä‡∑ê‡∂©‡∑ö. 80% ‡∂â‡∂ö‡∑ä‡∂∏‡∑Ä‡∑ì‡∂∏‡∑ö‡∂Ø‡∑ì üëè.</li>
    <li>üß† <b>‡∂∏‡∂≠‡∂ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂©‡∑è‡∑Ä</b> ‚Üí ‡∑É‡∂∏‡∑è‡∂± ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂∫‡∑î‡∂ú‡∂Ω ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂±‡∑ä‡∂±.</li>
    <li>üÖ∞Ô∏è <b>‡∑É‡∑ä‡∑Ä‡∂ª/‡∑Ä‡∑ä‚Äç‡∂∫‡∂Ç‡∂¢‡∂±</b> ‚Üí 12 ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂Ö‡∂≠‡∂ª‡∑í‡∂±‡∑ä ‡∑É‡∑ä‡∑Ä‡∂ª ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.</li>
    <li>‚ö° <b>‡∂ö‡∂©‡∑í‡∂±‡∂∏‡∑ä ‡∂ö‡∑ä‡∂Ω‡∑í‡∂ö‡∑ä</b> ‚Üí 20s ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠ ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö ‡∂Ö‡∂ö‡∑î‡∂ª‡∂ö‡∑ä ‡∑Ä‡∑ö‡∂ú‡∂∫‡∑ô‡∂±‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±.</li>
    <li>üé§ <b>Voice</b> ‚Üí ‡∂∏‡∂∫‡∑í‡∂ö‡∑ä ‡∂î‡∂±‡∑ë‡∂∏ ‡∑Ä‡∑ô‡∂Ω‡∑ö‡∂∏ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±; ‡∂∂‡∑ä‚Äç‡∂ª‡∑Ä‡∑î‡∑É‡∂ª‡∂∫ ‡∂ö‡∂Æ‡∂± ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏ ‡∑É‡∑Ñ ‡∂∏‡∑è‡∂∞‡∑ä‡∂∫ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∑É‡∑Ñ‡∂≠‡∑í‡∂ö ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Chrome/Edge).</li>
  </ol>
</section>

<!-- FAQ -->
<section id="faq" class="faq">
  <h2>‚ùì ‡∂¥‡∑ä‚Äç‡∂ª‡∑Å‡∑ä‡∂±</h2>
  <p><b>‡∂∏‡∂ú‡∑ö ‡∂Ø‡∂ª‡∑î‡∑Ä‡∑è‡∂ß ‡∂∏‡∑ö ‡∂Ö‡∂©‡∑Ä‡∑í‡∂∫‡∑ô‡∂±‡∑ä ‡∂ö‡∑î‡∂∏‡∂ö‡∑ä ‡∑É‡∑ú‡∂∫‡∑è‡∂ú‡∂≠ ‡∑Ñ‡∑ê‡∂ö?</b> ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏, ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂Ö‡∂≥‡∑í‡∂± ‡∂Ö‡∂∑‡∑ä‚Äç‡∂∫‡∑è‡∑É, ‡∂∏‡∂≠‡∂ö ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂©‡∑è, ‡∑Ñ‡∑è ‡∑Ä‡∂ª‡∑ä‡∂ú‡∑ì‡∂ö‡∂ª‡∂´/‡∑Ä‡∑ö‡∂ú ‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂©‡∑è.</p>
  <p><b>‡∂∏‡∑ô‡∂∏ ‡∂Ö‡∂©‡∑Ä‡∑í‡∂∫ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ö‡∂∏‡∂≠‡∂ª ‡∂∏‡∑ò‡∂Ø‡∑î‡∂ö‡∑è‡∂Ç‡∂ú ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂Ø?</b> ‡∂±‡∑ê‡∑Ñ‡∑ê, ‡∂î‡∂∂‡∑ö ‡∂∂‡∑ä‡∂ª‡∑Ä‡∑î‡∑É‡∂ª‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ ‡∂∏‡∑ö ‡∂Ö‡∂©‡∑Ä‡∑í‡∂∫ ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö. (‡∂í‡∂≠‡∑ä Voice features ‡∑É‡∂≥‡∑Ñ‡∑è Chrome/Edge ‡∑É‡∑î‡∂Ø‡∑î‡∑É‡∑î ‡∑Ä‡∑ö.)</p>
  <p><b>‡∂∏‡∑ô‡∂∏ ‡∂Ö‡∂©‡∑Ä‡∑í‡∂∫ ‡∑É‡∑Ñ‡∑è‡∂∫ ‡∂ö‡∂ª‡∂± ‡∂Ø‡∂ª‡∑î‡∑Ä‡∂±‡∑ä</b> ‡∑Ä‡∑í‡∑Å‡∑ö‡∑Ç‡∂∫‡∑ô‡∂±‡∑ä‡∂∏ <b>‡∂©‡∑í‡∑É‡∑ä‡∂ú‡∑ä‚Äç‡∂ª‡∑è‡∑Ü‡∑í‡∂∫‡∑è</b> ‡∑É‡∑Ñ ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂Ω‡∑í‡∑Ä‡∑ì‡∂∏‡∑ö ‡∂Ö‡∂¥‡∑Ñ‡∑É‡∑î‡∂≠‡∑è ‡∂á‡∂≠‡∑í ‡∂Ø‡∂ª‡∑î‡∑Ä‡∂±‡∑ä‡∂ß, ‡∂±‡∂∏‡∑î‡∂≠‡∑ä ‡∂ï‡∂±‡∑ë‡∂∏ ‡∑Ö‡∂∏‡∂ö‡∑î‡∂ß‡∂∏ ‡∂ã‡∂Ø‡∑Ä‡∑ä ‡∑Ä‡∑ö.</p>
</section>

<!-- Feedback -->
<section id="feedback" class="feedback">
  <h2>üìù ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä</h2>
  <form id="feedbackForm">
    <label>‡∂±‡∂∏:</label><input type="text" id="name" required style="width:100%;padding:8px;border:1px solid var(--accent);border-radius:6px">
    <label>‡∂ä‡∂∏‡∑ö‡∂Ω‡∑ä:</label><input type="email" id="email" required style="width:100%;padding:8px;border:1px solid var(--accent);border-radius:6px">
    <label>‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä:</label><textarea id="message" rows="4" required style="width:100%;padding:8px;border:1px solid var(--accent);border-radius:6px"></textarea>
    <button type="submit">‡∂∫‡∑Ä‡∂±‡∑ä‡∂±</button>
  </form>
  <p id="feedbackMsg" style="color:green;font-weight:700"></p>
</section>

<!-- Contact -->
<section id="contact">
  <h2>üìû ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∑Ä‡∑ì‡∂∏</h2>
  <p>üìû 070 422 6267</p>
  <p>‚úâÔ∏è support@writeease.lk</p>
</section>

<footer>
  <p>¬© 2025 ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î ‡∂∏‡∑í‡∂≠‡∑î‡∂ª‡∑è | ‡∑Ö‡∂∏‡∑î‡∂±‡∑ä ‡∑É‡∂≥‡∑Ñ‡∑è ‡∑Ñ‡∑í‡∂≠‡∂ö‡∑è‡∂∏‡∑ì ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂±‡∑í‡∂ö ‡∂Ö‡∂©‡∑Ä‡∑í‡∂∫</p>
</footer>

<!-- Hidden admin panel (not visible to normal users). You can unhide with CSS for admin access.) -->
<div id="adminPanel" aria-hidden="true">
  <button onclick="downloadData()">Download CSV (admin)</button>
</div>

<script>
/* ===== Shared data & helpers ===== */
const sinhalaLetters = ["‡∂Ö","‡∂Ü","‡∂á","‡∂à","‡∂â","‡∂ä","‡∂ã","‡∂å","‡∂ç","‡∂é","‡∂è","‡∂ê","‡∂ë","‡∂í","‡∂ì","‡∂î","‡∂ï","‡∂ñ",
  "‡∂ö","‡∂õ","‡∂ú","‡∂ù","‡∂û","‡∂ü","‡∂†","‡∂°","‡∂¢","‡∂£","‡∂§","‡∂•","‡∂ß","‡∂®","‡∂©","‡∂™","‡∂´","‡∂¨",
  "‡∂≠","‡∂Æ","‡∂Ø","‡∂∞","‡∂±","‡∂≥","‡∂¥","‡∂µ","‡∂∂","‡∂∑","‡∂∏","‡∂π","‡∂∫","‡∂ª","‡∂Ω","‡∑Ä","‡∑Å","‡∑Ç","‡∑É","‡∑Ñ","‡∑Ö","‡∑Ü"];

/* local data store */
let gameHistory = JSON.parse(localStorage.getItem("akuruMithuraHistory") || "[]");
function saveRecord(data){
  const record = { timestamp: new Date().toLocaleString(), ...data };
  gameHistory.push(record);
  localStorage.setItem("akuruMithuraHistory", JSON.stringify(gameHistory));
}
/* export helper */
function downloadData(){
  if(!gameHistory.length){ alert("No history to export."); return; }
  let csv = "Timestamp,Game,Attempts,Correct,Accuracy,Extra\n";
  gameHistory.forEach(r=>{
    const extra = (r.extra||"").toString().replace(/"/g,'""');
    csv += `"${r.timestamp}","${r.game}",${r.attempts||""},${r.correct||""},${r.accuracy||""},"${extra}"\n`;
  });
  const blob = new Blob([csv], {type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "AkuruMithura_History.csv"; a.click();
  URL.revokeObjectURL(url);
}
function getAllHistory(){ return gameHistory; } // accessible in console

/* ===== Activities: Find the letter ===== */
const lettersGrid = document.getElementById("lettersGrid");
const targetLetterEl = document.getElementById("targetLetter");
const activityMsg = document.getElementById("activityMsg");
let findCorrect=0, findTotal=0;
function updateFindStats(){
  document.getElementById("findScore").innerText = findCorrect;
  document.getElementById("findTotal").innerText = findTotal;
  const acc = findTotal ? ((findCorrect/findTotal)*100).toFixed(1) : 0;
  document.getElementById("findAccuracy").innerText = acc + "%";
}
function newTarget(){
  targetLetterEl.textContent = sinhalaLetters[Math.floor(Math.random()*sinhalaLetters.length)];
  activityMsg.textContent = "";
}
sinhalaLetters.forEach(l=>{
  const d=document.createElement("div"); d.className="letter"; d.textContent=l;
  d.onclick=()=>{
    findTotal++;
    if(d.textContent === targetLetterEl.textContent){
      findCorrect++; activityMsg.textContent = "‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í! üëè ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í.";
      document.getElementById("successSound")?.play();
      newTarget();
    } else {
      activityMsg.textContent = "‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!";
    }
    updateFindStats();
    // save a small record for activity
    saveRecord({game:"find-letter", attempts: findTotal, correct: findCorrect, accuracy: ((findTotal)?Math.round((findCorrect/findTotal)*100):0)});
  };
  lettersGrid.appendChild(d);
});
newTarget(); updateFindStats();

/* ===== Tracing Game (mask-based) ===== */
const traceCanvas = document.getElementById("traceCanvas");
const ctx = traceCanvas.getContext("2d");
const maskCanvas = document.createElement("canvas");
maskCanvas.width = traceCanvas.width; maskCanvas.height = traceCanvas.height;
const mctx = maskCanvas.getContext("2d");

let currentLetterIndex = 0;
let isDrawing=false,lastX=0,lastY=0,maskData=null,maskTotal=0,coveredSet=new Set(),traceComplete=false;

function computeFontSize(letter){
  let size=160; ctx.textAlign="center"; ctx.textBaseline="middle";
  while(size>30){
    ctx.font = `${size}px Noto Sans Sinhala`;
    const w = ctx.measureText(letter).width;
    if(w <= traceCanvas.width*0.78) break;
    size -= 4;
  }
  return size;
}
function buildMask(letter){
  mctx.clearRect(0,0,maskCanvas.width, maskCanvas.height);
  const size = computeFontSize(letter);
  mctx.font = `${size}px Noto Sans Sinhala`;
  mctx.textAlign="center"; mctx.textBaseline="middle";
  mctx.lineJoin="round"; mctx.lineCap="round"; mctx.lineWidth = 18; mctx.strokeStyle = "#000";
  mctx.strokeText(letter, maskCanvas.width/2, maskCanvas.height/2);
  const img = mctx.getImageData(0,0,maskCanvas.width,maskCanvas.height);
  maskData = img.data; maskTotal=0;
  for(let y=0;y<maskCanvas.height;y++){
    for(let x=0;x<maskCanvas.width;x++){
      const a = maskData[(y*maskCanvas.width + x)*4 + 3];
      if(a>0) maskTotal++;
    }
  }
  coveredSet.clear(); traceComplete=false; updateTraceAccuracy(0);
}
function drawLetterOutline(letter){
  ctx.clearRect(0,0,traceCanvas.width,traceCanvas.height);
  const size = computeFontSize(letter);
  ctx.font = `${size}px Noto Sans Sinhala`;
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.lineJoin="round"; ctx.lineCap="round"; ctx.lineWidth = 3; ctx.strokeStyle = "#cccccc";
  ctx.strokeText(letter, traceCanvas.width/2, traceCanvas.height/2);
}
function updateTraceAccuracy(pct){ document.getElementById("traceAccuracy").innerText = Math.min(100, Math.round(pct)); }

function startTracing(){
  const letter = sinhalaLetters[currentLetterIndex];
  drawLetterOutline(letter); buildMask(letter);
  document.getElementById("traceMotivation").textContent = "";
  // clear drawn strokes area by drawing outline then return
}
function clearTracing(){ drawLetterOutline(sinhalaLetters[currentLetterIndex]); buildMask(sinhalaLetters[currentLetterIndex]); document.getElementById("traceMotivation").textContent=""; }
function nextTracing(){ currentLetterIndex=(currentLetterIndex+1)%sinhalaLetters.length; startTracing(); }

function coverAlongLine(x0,y0,x1,y1){
  const dx=x1-x0, dy=y1-y0; const steps = Math.max(Math.abs(dx), Math.abs(dy));
  if(steps===0) return 0;
  let newly=0; const sx=dx/steps, sy=dy/steps;
  for(let i=0;i<=steps;i++){
    const x=Math.round(x0 + sx*i), y=Math.round(y0 + sy*i);
    if(x<0||y<0||x>=maskCanvas.width||y>=maskCanvas.height) continue;
    const idx = y*maskCanvas.width + x; const a = maskData[idx*4 + 3];
    if(a>0 && !coveredSet.has(idx)){ coveredSet.add(idx); newly++; }
  }
  return newly;
}

traceCanvas.addEventListener("mousedown",(e)=>{ isDrawing=true; lastX=e.offsetX; lastY=e.offsetY; ctx.beginPath(); ctx.moveTo(lastX,lastY); });
traceCanvas.addEventListener("mousemove",(e)=>{
  if(!isDrawing||!maskData) return;
  const x=e.offsetX, y=e.offsetY;
  ctx.strokeStyle="#0096c7"; ctx.lineWidth=6; ctx.lineCap="round"; ctx.lineJoin="round"; ctx.lineTo(x,y); ctx.stroke();
  coverAlongLine(lastX,lastY,x,y);
  const pct = (coveredSet.size / maskTotal) * 100;
  updateTraceAccuracy(pct);
  if(!traceComplete && pct >= 80){
    traceComplete=true;
    document.getElementById("traceMotivation").textContent = "‡∂â‡∂≠‡∑è ‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í! üëè 80% ‡∂â‡∂ö‡∑ä‡∂∏‡∑Ä‡∑è ‡∂á‡∂≠.";
    document.getElementById("successSound")?.play();
    // save trace result
    saveRecord({game:"tracing", attempts:1, correct: (pct>=80?1:0), accuracy: Math.round(pct), extra: sinhalaLetters[currentLetterIndex]});
  }
  lastX=x; lastY=y;
});
["mouseup","mouseout"].forEach(ev => traceCanvas.addEventListener(ev, ()=>{ isDrawing=false; ctx.closePath(); }));

document.getElementById("traceStartBtn").addEventListener("click", startTracing);
document.getElementById("traceClearBtn").addEventListener("click", clearTracing);
document.getElementById("traceNextBtn").addEventListener("click", nextTracing);

/* initialize tracing first letter */
startTracing();

/* ===== Memory Game (two-sided matching) ===== */
const memoryGameEl = document.getElementById("memoryGame");
const memoryStartBtn = document.getElementById("memoryStartBtn");
let memoryState = {attempts:0, correct:0};
function initMemoryGame(){
  memoryGameEl.innerHTML = "";
  const letters = ["‡∂Ö","‡∂Ü","‡∂ö","‡∂ú","‡∂≠","‡∂Ø"]; // pairs
  const cards = [...letters, ...letters].sort(()=>0.5-Math.random());
  let flipped=[];
  memoryState = {attempts:0, correct:0};
  document.getElementById("memoryMotivation").innerText = "";
  cards.forEach((letter, idx)=>{
    const card = document.createElement("div"); card.className="memory-card";
    card.dataset.letter = letter;
    card.innerHTML = `<div class="memory-card-inner"><div class="memory-card-front">‚ùì</div><div class="memory-card-back">${letter}</div></div>`;
    card.addEventListener("click", () => {
      if(card.classList.contains("flipped") || flipped.length===2) return;
      card.classList.add("flipped"); flipped.push(card);
      if(flipped.length===2){
        memoryState.attempts++;
        const a = flipped[0].dataset.letter, b = flipped[1].dataset.letter;
        if(a === b){
          memoryState.correct++; document.getElementById("memoryMotivation").innerText = "‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í! üëè"; flipped=[];
        } else {
          document.getElementById("memoryMotivation").innerText = "‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!";
          setTimeout(()=>{ flipped.forEach(c=>c.classList.remove("flipped")); flipped=[]; }, 900);
        }
        const acc = Math.round((memoryState.correct / memoryState.attempts)*100) || 0;
        document.getElementById("memoryAccuracy").innerText = acc;
        // save a record (each round)
        saveRecord({game:"memory", attempts: memoryState.attempts, correct: memoryState.correct, accuracy: acc});
      }
    });
    memoryGameEl.appendChild(card);
  });
}
memoryStartBtn.addEventListener("click", initMemoryGame);

/* ===== Vowel / Consonant ===== */
const vowels = new Set(["‡∂Ö","‡∂Ü","‡∂á","‡∂à","‡∂â","‡∂ä","‡∂ã","‡∂å","‡∂ç","‡∂é","‡∂è","‡∂ê","‡∂ë","‡∂í","‡∂ì","‡∂î","‡∂ï","‡∂ñ"]);
let vcCorrect=0, vcTotal=0;
function updateVCStats(){ const acc = vcTotal? ((vcCorrect/vcTotal)*100).toFixed(1):0; document.getElementById("vcCorrect").innerText=vcCorrect; document.getElementById("vcTotal").innerText=vcTotal; document.getElementById("vcAcc").innerText=acc+"%"; }
function newVCRound(){
  const holder = document.getElementById("vcGrid"); holder.innerHTML=""; document.getElementById("vcMsg").textContent="";
  const picks=[];
  while(picks.length<12){ picks.push(sinhalaLetters[Math.floor(Math.random()*sinhalaLetters.length)]); }
  picks.forEach(l=>{
    const d = document.createElement("div"); d.className="tile"; d.textContent=l;
    d.addEventListener("click", ()=>{
      vcTotal++;
      if(vowels.has(l)){ vcCorrect++; d.classList.add("correct"); d.style.pointerEvents="none"; document.getElementById("vcMsg").innerText = "‡∑Ñ‡∑ú‡∂≥‡∂∫‡∑í! üëè"; document.getElementById("successSound")?.play(); }
      else { d.classList.add("wrong"); d.style.pointerEvents="none"; document.getElementById("vcMsg").innerText = "‡∂∏‡∑ô‡∂∫ ‡∑Ä‡∑ä‚Äç‡∂∫‡∂Ç‡∂¢‡∂±‡∂∫‡∂ö‡∑í!"; }
      updateVCStats();
      saveRecord({game:"vowel-consonant", attempts: vcTotal, correct: vcCorrect, accuracy: Math.round((vcCorrect/vcTotal)*100) || 0});
    });
    holder.appendChild(d);
  });
}
function revealVC(){ document.querySelectorAll("#vcGrid .tile").forEach(n=>{ if(vowels.has(n.textContent)) n.classList.add("correct"); else n.classList.add("wrong"); n.style.pointerEvents="none"; }); }
document.getElementById("vcNewBtn").addEventListener("click", newVCRound);
document.getElementById("vcRevealBtn").addEventListener("click", revealVC);
newVCRound();

/* ===== Speed Tap (fixed) ===== */
let tapTime = 20, tapTimerId=null, tapRunning=false, tapScore=0, tapAttempts=0, currentTapTarget="";
function randomChoices(n=12){ const arr=[]; for(let i=0;i<n;i++) arr.push(sinhalaLetters[Math.floor(Math.random()*sinhalaLetters.length)]); return arr; }
function renderTapRound(){
  currentTapTarget = sinhalaLetters[Math.floor(Math.random()*sinhalaLetters.length)];
  document.getElementById("tapTarget").innerText = currentTapTarget;
  const grid = document.getElementById("tapGrid"); grid.innerHTML="";
  const choices = randomChoices(12);
  if(!choices.includes(currentTapTarget)) choices[Math.floor(Math.random()*choices.length)] = currentTapTarget;
  choices.forEach(ch=>{
    const t = document.createElement("div"); t.className="tile"; t.textContent=ch;
    t.addEventListener("click", ()=>{
      if(!tapRunning) return;
      tapAttempts++;
      if(ch===currentTapTarget){ tapScore++; document.getElementById("tapMsg").innerText = "‡∑É‡∑î‡∂¥‡∑í‡∂ª‡∑í! ‚úÖ"; document.getElementById("successSound")?.play(); }
      else document.getElementById("tapMsg").innerText = "‡∂Ö‡∑Ä‡∑è‡∑É‡∂±‡∑è‡∑Ä‡∂ß üòÖ";
      updateTapStats();
      renderTapRound();
    });
    grid.appendChild(t);
  });
}
function updateTapStats(){ document.getElementById("tapScore").innerText = tapScore; document.getElementById("tapAttempts").innerText = tapAttempts; const acc = tapAttempts? ((tapScore/tapAttempts)*100).toFixed(1):0; document.getElementById("tapAcc").innerText = acc + "%"; }
function startTap(){
  if(tapRunning) return;
  tapRunning=true; tapTime=20; tapScore=0; tapAttempts=0; document.getElementById("tapMsg").innerText="";
  updateTapStats(); renderTapRound(); document.getElementById("tapTimer").innerText = tapTime;
  tapTimerId = setInterval(()=>{
    tapTime--; document.getElementById("tapTimer").innerText = tapTime;
    if(tapTime<=0){ clearInterval(tapTimerId); tapRunning=false; document.getElementById("tapMsg").innerText = "‡∂ö‡∑è‡∂Ω‡∂∫ ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä! üèÅ"; const acc = tapAttempts? Math.round((tapScore/tapAttempts)*100):0; saveRecord({game:"tap", attempts:tapAttempts, correct:tapScore, accuracy: acc}); }
  },1000);
}
document.getElementById("tapStartBtn").addEventListener("click", startTap);

/* ===== Voice record + SpeechRecognition + transcript & accuracy ===== */
const startRecBtn = document.getElementById("startRecBtn"), stopRecBtn = document.getElementById("stopRecBtn");
const playRecBtn = document.getElementById("playRecBtn"), downloadRecBtn = document.getElementById("downloadRecBtn");
const transcriptEl = document.getElementById("transcript"), recordedAudio = document.getElementById("recordedAudio");
let mediaRecorder, audioChunks=[], audioBlob, audioUrl, recog;

async function startRecording(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder = new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable = e=>{ if(e.data && e.data.size>0) audioChunks.push(e.data); };
    mediaRecorder.onstop = ()=>{ audioBlob = new Blob(audioChunks,{type:"audio/webm"}); audioUrl = URL.createObjectURL(audioBlob); recordedAudio.src = audioUrl; playRecBtn.disabled = false; downloadRecBtn.disabled=false; };
    mediaRecorder.start();

    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ transcriptEl.value = "‚ùå SpeechRecognition not supported in this browser. Use Chrome/Edge."; }
    else {
      recog = new SR();
      recog.lang = "si-LK"; recog.continuous = true; recog.interimResults = true;
      recog.onresult = (e) => {
        let text = "";
        for(let i=0;i<e.results.length;i++){
          text += e.results[i][0].transcript + (e.results[i].isFinal ? "" : "");
        }
        transcriptEl.value = text.trim();
        // compute accuracy
        const plain = text.replace(/\s+/g,"").replace(/[^\u0D80-\u0DFF]/g,"");
        if(plain.length>0){
          let correctChars=0;
          for(let ch of plain) if(sinhalaLetters.includes(ch)) correctChars++;
          const acc = Math.round((correctChars/plain.length)*100);
          document.getElementById("voiceAcc").innerText = acc + "%";
        }
      };
      recog.onerror = (ev)=>{ console.error("recog error", ev); };
      recog.start();
    }

    startRecBtn.disabled = true; stopRecBtn.disabled = false;
    transcriptEl.value = "üéôÔ∏è Recording... speak Sinhala";
  }catch(err){
    console.error("mic err",err); transcriptEl.value = "‚ùå Cannot access microphone.";
  }
}
function stopRecording(){
  if(mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
  if(recog) try{ recog.stop(); }catch(e){}
  startRecBtn.disabled=false; stopRecBtn.disabled=true;
  // compute final accuracy & save
  const text = transcriptEl.value || "";
  const plain = text.replace(/\s+/g,"").replace(/[^\u0D80-\u0DFF]/g,"");
  const total = plain.length;
  let correctChars=0; for(let ch of plain) if(sinhalaLetters.includes(ch)) correctChars++;
  const acc = total? Math.round((correctChars/total)*100):0;
  document.getElementById("voiceAcc").innerText = acc + "%";
  // save record
  saveRecord({game:"voice", attempts:1, correct: correctChars, accuracy: acc, extra: text});
}
startRecBtn.addEventListener("click", startRecording);
stopRecBtn.addEventListener("click", stopRecording);
playRecBtn.addEventListener("click", ()=>{ if(recordedAudio.src) recordedAudio.play(); });
downloadRecBtn.addEventListener("click", ()=>{ if(!audioUrl) return; const a=document.createElement("a"); a.href=audioUrl; a.download="recording.webm"; a.click(); });

/* ===== Feedback form ===== */
document.getElementById("feedbackForm").addEventListener("submit", function(e){
  e.preventDefault();
  document.getElementById("feedbackMsg").innerText = "‚úÖ ‡∂î‡∂∂‡∑ö ‡∂Ö‡∂Ø‡∑Ñ‡∑É‡∑ä ‡∂Ö‡∂¥‡∂ß ‡∂Ω‡∑ê‡∂∂‡∑ì ‡∂á‡∂≠!";
  // optionally store feedback in localStorage (not exported in game CSV)
  const fb = { name: this.name.value, email: this.email.value, message: this.message.value, ts: new Date().toLocaleString() };
  localStorage.setItem("akuruMithuraFeedback", JSON.stringify((JSON.parse(localStorage.getItem("akuruMithuraFeedback")||"[]")).concat(fb)));
  this.reset();
});

/* ===== Overall accuracy calculation ===== */
function calculateOverall(){
  // Find most recent accuracy metrics
  const traceAcc = parseInt(document.getElementById("traceAccuracy").innerText) || 0;
  const memAcc = parseInt(document.getElementById("memoryAccuracy").innerText) || 0;
  const vcAcc = parseInt(document.getElementById("vcAcc").innerText) || 0;
  const tapAcc = parseInt(document.getElementById("tapAcc").innerText) || 0;
  const voiceAcc = parseInt(document.getElementById("voiceAcc").innerText) || 0;
  const arr = [traceAcc, memAcc, vcAcc, tapAcc, voiceAcc].filter(a=>!isNaN(a));
  const overall = arr.length ? Math.round(arr.reduce((s,v)=>s+v,0)/arr.length) : 0;
  document.getElementById("overallAccuracy").innerText = overall;
}

/* ===== On load default initializations ===== */
window.onload = function(){
  // tracing started earlier
  document.getElementById("memoryGame").innerHTML = "";
  newVCRound();
  // tie some UI buttons
  document.getElementById("memoryStartBtn").addEventListener("click", initMemoryGame);
  // initialize tap grid empty
  document.getElementById("tapGrid").innerHTML = "";
};

/* Expose admin helpers in console if needed */
window.getAllHistory = getAllHistory;
window.saveRecord = saveRecord;
window.downloadData = downloadData;

</script>
</body>
</html>
